<!DOCTYPE html>
<html lang="zh-Hant" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ… è–èª•ç‰¹åˆ¥ç‰ˆï¼šæ¨™æ¡ˆæˆ°æƒ…å®¤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;600;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        /* === ğŸ„ è–èª•ä¸»é¡Œè®Šæ•¸å®šç¾© (é‡æ–°å®šç¾©è‰²å½©) === */
        :root {
            --bg-dark: #1a0f0f;       /* æ·±ç´…æ£•è‰²èƒŒæ™¯ï¼Œå–ä»£æµ·è»è— */
            --bg-panel: #2b1a1a;      /* æ·±è‰²é¢æ¿ */
            --accent-cyan: #165b33;   /* è–èª•ç¶  (å–ä»£åŸæœ¬çš„éœ“è™¹é’) */
            --accent-amber: #d42426;  /* è–èª•ç´… (å–ä»£åŸæœ¬çš„ç¥ç€è‰²) */
            --accent-gold: #f8b229;   /* æ–°å¢ï¼šè–èª•é‡‘ (ç”¨æ–¼å¼·èª¿) */
            --accent-red: #ff3366;    /* ä¿ç•™åŸæœ¬çš„æ•¸ç¢¼ç´…ç”¨æ–¼ç·Šæ€¥ */
            --text-bright: #f0f0f0;   /* ç±³ç™½è‰²æ–‡å­— */
            --text-muted: #b0b0b0;    /* æ¬¡è¦æ–‡å­— */
            --font-tech: 'Chakra Petch', sans-serif;
            --font-digital: 'Orbitron', sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-bright);
            font-family: var(--font-tech);
            min-height: 100vh;
            /* æ›¿æ›èƒŒæ™¯ç‚ºé©åˆé›ªæ™¯çš„æ¼¸å±¤ */
            background-image: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
            padding-bottom: 50px;
            position: relative;
            overflow-x: hidden; /* é˜²æ­¢é›ªèŠ±é€ æˆæ°´å¹³æ²å‹• */
        }

        /* === â„ï¸ é›ªèŠ±ç‰¹æ•ˆ CSS === */
        #snow-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1; /* åœ¨æœ€åº•å±¤èƒŒæ™¯ä¹‹ä¸Š */
        }
        .snow {
            position: absolute; width: 10px; height: 10px; background: white;
            border-radius: 50%; filter: drop-shadow(0 0 10px white);
            animation: snowfall linear infinite;
        }
        @keyframes snowfall {
            0% { transform: translateY(-10vh) translateX(0); opacity: 1; }
            100% { transform: translateY(110vh) translateX(20px); opacity: 0.3; }
        }
        
        /* è®“ä¸»è¦å…§å®¹æµ®åœ¨é›ªèŠ±ä¸Šé¢ */
        .container-fluid, #status-bar {
            position: relative; z-index: 10;
        }

        /* === ğŸ… è–èª•è£é£¾åœ–ç¤ºæ¨£å¼ === */
        .xmas-deco-container {
            display: flex; align-items: center; gap: 15px; margin-right: 25px;
        }
        .xmas-icon {
            height: 80px; /* æ”¾å¤§åœ–ç¤º */
            width: auto; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); cursor: pointer;
        }
        .xmas-icon:hover {
            transform: translateY(-5px) scale(1.1) rotate(5deg);
            filter: drop-shadow(0 0 15px var(--accent-gold)); /* ç™¼é‡‘è‰²å…‰ */
        }

        /* === ç³»çµ±ç‹€æ…‹æ¢ === */
        #status-bar { 
            display: none; padding: 8px 20px; font-size: 0.9rem; text-align: center; 
            color: white; font-weight: bold;
            background-color: var(--accent-amber); /* æ”¹ç‚ºè–èª•ç´… */
            box-shadow: 0 0 15px var(--accent-amber);
        }
        .status-indicator-container {
            font-family: var(--font-digital); font-size: 0.9rem;
            color: var(--accent-cyan); /* æ”¹ç‚ºè–èª•ç¶  */
            text-shadow: 0 0 5px var(--accent-cyan);
        }

        /* === 1. é ‚éƒ¨æ¨™é¡Œåˆ— (è–èª•é…è‰²) === */
        .war-room-header {
            padding: 1.5rem 0; margin-bottom: 2rem;
            /* æ”¹ç‚ºç´…ç¶ æ¼¸å±¤é‚Šæ¡†å’ŒèƒŒæ™¯ */
            border-bottom: 2px solid var(--accent-gold);
            background: linear-gradient(90deg, rgba(26,15,15,0) 0%, rgba(22,91,51,0.2) 50%, rgba(26,15,15,0) 100%);
        }
        .header-title {
            font-family: var(--font-digital); font-weight: 700; letter-spacing: 2px;
            text-transform: uppercase; color: var(--accent-gold); /* é‡‘è‰²æ¨™é¡Œ */
            text-shadow: 0 0 10px rgba(248, 178, 41, 0.5);
        }

        /* === 2. æ§åˆ¶å€ (è–èª•é…è‰²) === */
        .control-panel {
            background: rgba(43, 26, 26, 0.6); /* æ·±ç´…è‰²åŠé€æ˜ */
            padding: 2rem; border-radius: 16px;
            border: 2px solid var(--accent-cyan); /* ç¶ è‰²é‚Šæ¡† */
            backdrop-filter: blur(10px); max-width: 900px; margin: 0 auto 3rem auto;
            box-shadow: 0 0 20px rgba(22, 91, 51, 0.2);
        }
        .search-input-cyber {
            background-color: rgba(26, 15, 15, 0.8);
            border: 2px solid var(--accent-gold); /* é‡‘è‰²é‚Šæ¡† */
            color: var(--text-bright); padding: 15px 25px; font-size: 1.1rem;
            border-radius: 50px; transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(248, 178, 41, 0.3);
        }
        .search-input-cyber:focus {
            background-color: rgba(26, 15, 15, 1); color: white; outline: none;
            box-shadow: 0 0 20px rgba(248, 178, 41, 0.6); border-color: var(--accent-gold);
        }
        .keyword-btn {
            background: transparent; border: 1px solid var(--text-muted); color: var(--text-muted);
            padding: 8px 16px; border-radius: 30px; font-size: 0.9rem; cursor: pointer;
            transition: all 0.3s; font-family: var(--font-digital); letter-spacing: 1px; margin: 4px;
        }
        .keyword-btn:hover, .keyword-btn.active {
            border-color: var(--accent-gold); color: var(--bg-dark);
            background: var(--accent-gold); /* é‡‘è‰²æŒ‰éˆ• */
            box-shadow: 0 0 15px rgba(248, 178, 41, 0.5); font-weight: bold;
        }
        .keyword-badge-count {
            background-color: var(--accent-cyan); color: white; /* ç¶ åº•ç™½å­— */
            font-size: 0.75rem; padding: 2px 6px; border-radius: 10px; margin-left: 5px;
        }

        /* === 3. çµ±è¨ˆæ•¸æ“šå€ (è–èª•é…è‰²) === */
        .stat-card-cyber {
            background: var(--bg-panel); border: 2px solid var(--accent-cyan); /* ç¶ è‰²é‚Šæ¡† */
            border-radius: 12px; padding: 25px; text-align: center; position: relative;
            overflow: hidden; transition: transform 0.3s; height: 100%;
        }
        .stat-card-cyber:hover {
            transform: translateY(-5px); border-color: var(--accent-gold); /* hoverè®Šé‡‘è‰² */
            box-shadow: 0 0 15px rgba(248, 178, 41, 0.3) inset;
        }
        .stat-card-cyber::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            /* æ”¹ç‚ºç´…ç¶ æƒæç·š */
            background: linear-gradient(transparent 50%, rgba(212, 36, 38, 0.05) 50%);
            background-size: 100% 4px; pointer-events: none;
        }
        .stat-num-digital {
            font-family: var(--font-digital); font-size: 2.8rem; font-weight: 700;
            display: block; margin-bottom: 10px; text-shadow: 0 0 10px currentColor;
        }
        .num-red { color: var(--accent-amber); } /* ä»Šæ—¥ï¼šè–èª•ç´… */
        .num-blue { color: var(--accent-cyan); }  /* æ­·å²ï¼šè–èª•ç¶  */
        .num-white { color: var(--accent-gold); } /* ç¸½æ•¸ï¼šè–èª•é‡‘ */
        .stat-label { color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; font-size: 0.85rem; }

        /* === 4. å°èˆªåˆ†é  (è–èª•é…è‰²) === */
        .nav-pills-cyber .nav-link {
            color: var(--text-muted); background: rgba(43, 26, 26, 0.5);
            border: 1px solid var(--accent-cyan); border-radius: 50px;
            padding: 10px 25px; margin: 0 5px; font-family: var(--font-tech);
            letter-spacing: 1px; transition: all 0.3s;
        }
        .nav-pills-cyber .nav-link:hover { color: var(--accent-gold); border-color: var(--accent-gold); }
        .nav-pills-cyber .nav-link.active {
            background: var(--accent-cyan); color: white; font-weight: 700; /* ç¶ åº•ç™½å­— */
            box-shadow: 0 0 15px rgba(22, 91, 51, 0.6); border-color: var(--accent-cyan);
        }

        /* === 5. è³‡æ–™åˆ—è¡¨ (è–èª•é…è‰²é¢æ¿) === */
        .tender-card-tech {
            background: var(--bg-panel); border: 1px solid var(--accent-cyan);
            border-left: 4px solid; border-radius: 8px; margin-bottom: 20px;
            padding: 20px; position: relative; transition: all 0.3s;
        }
        .tender-card-tech:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.3), 0 0 15px rgba(22, 91, 51, 0.2) inset;
            transform: scale(1.01); border-color: var(--accent-gold);
        }
        .source-pis { border-left-color: var(--accent-amber); } /* æ¡è³¼ç¶²-è–èª•ç´… */
        .source-env { border-left-color: var(--accent-cyan); }  /* ç’°å¢ƒéƒ¨-è–èª•ç¶  */

        .org-badge-tech {
            background: rgba(22, 91, 51, 0.2); color: var(--accent-cyan);
            border: 1px solid var(--accent-cyan); padding: 4px 10px; border-radius: 4px;
            font-size: 0.8rem; text-transform: uppercase;
        }
        .source-pis .org-badge-tech {
            background: rgba(212, 36, 38, 0.2); color: var(--accent-amber); border-color: var(--accent-amber);
        }
        .tag-badge-tech {
             background: rgba(255, 255, 255, 0.1); color: var(--text-muted);
             border: 1px solid var(--text-muted); padding: 4px 10px; border-radius: 4px;
             font-size: 0.8rem; margin-left: 8px;
        }
        .tender-title-tech {
            font-size: 1.25rem; color: var(--text-bright); text-decoration: none;
            display: block; margin: 12px 0; font-weight: 600;
        }
        .tender-title-tech:hover { color: var(--accent-gold); text-shadow: 0 0 10px rgba(248, 178, 41, 0.5); }

        .info-row-tech { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px; align-items: center; }
        .info-item-tech {
            background: rgba(26, 15, 15, 0.6); border: 1px solid var(--accent-cyan);
            padding: 6px 12px; border-radius: 30px; font-size: 0.9rem; color: var(--text-muted);
            display: flex; align-items: center;
        }
        .info-item-tech i { margin-right: 8px; color: var(--accent-cyan); opacity: 0.8; }
        .budget-text { color: var(--accent-gold); font-family: var(--font-digital); font-weight: 700; text-shadow: 0 0 5px rgba(248, 178, 41, 0.5);}
        .deadline-text { color: var(--accent-amber); font-weight: 600; }

        /* åˆ†ææŒ‰éˆ• (è–èª•æ¼¸å±¤) */
        .btn-analyze-tech {
            /* ç´…ç¶ æ¼¸å±¤ */
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-amber));
            border: none; color: white; padding: 6px 15px; border-radius: 30px;
            font-size: 0.85rem; cursor: pointer; transition: all 0.3s;
            display: inline-flex; align-items: center; box-shadow: 0 0 10px rgba(22, 91, 51, 0.4);
        }
        .btn-analyze-tech:hover { box-shadow: 0 0 15px var(--accent-gold); transform: scale(1.05); }
        .btn-analyze-tech:disabled { background: #475569; box-shadow: none; cursor: not-allowed; opacity: 0.7; transform: none;}
        
        .btn-view-tech {
             background: transparent; border: 1px solid var(--accent-gold); color: var(--accent-gold);
             padding: 6px 15px; border-radius: 30px; font-size: 0.85rem; text-decoration: none; transition: all 0.3s;
        }
        .btn-view-tech:hover { background: var(--accent-gold); color: var(--bg-dark); box-shadow: 0 0 15px rgba(248, 178, 41, 0.5); }

        /* å…¶ä»–å…ƒç´  */
        .date-separator { display: flex; align-items: center; margin: 30px 0 20px 0; color: var(--text-muted); font-family: var(--font-digital); }
        .date-separator::before, .date-separator::after { content: ""; flex: 1; border-bottom: 1px solid var(--accent-cyan); }
        .date-text { background-color: var(--bg-panel); padding: 5px 15px; border-radius: 20px; border: 1px solid var(--accent-cyan); }
        .loading-cyber { text-align: center; padding: 60px; color: var(--accent-cyan); opacity: 0.8; }
        .empty-state { text-align: center; padding: 80px; color: var(--text-muted); opacity: 0.6; }
        .spinner-border-sm { width: 0.8rem; height: 0.8rem; border-width: 0.15em; margin-right: 5px; }
        
        /* è¿”å›ä¸»é æŒ‰éˆ• */
        .btn-back-home {
            position: fixed; bottom: 30px; right: 30px; z-index: 99;
            background-color: var(--accent-cyan); color: white;
            border: 2px solid var(--accent-gold); border-radius: 50px; padding: 12px 25px;
            font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: all 0.3s; display: flex; align-items: center;
        }
        .btn-back-home:hover { background-color: var(--accent-amber); transform: scale(1.1); color: var(--accent-gold); box-shadow: 0 0 20px var(--accent-gold); text-decoration: none;}
    </style>
</head>
<body>

    <div id="snow-container"></div>

    <div id="status-bar"></div>

    <div class="container-fluid px-lg-5">
        <header class="war-room-header d-flex justify-content-between align-items-center">
            <h1 class="header-title mb-0">
                <i class="fas fa-tree me-2" style="color: var(--accent-cyan);"></i>è–èª•æˆ°æƒ…å®¤
            </h1>
            <div class="d-flex align-items-center">
                <div class="xmas-deco-container d-none d-md-flex">
                    <img src="santa_eco.png" alt="Eco Santa" class="xmas-icon" title="ç’°ä¿è–èª•è€äººä¾†é€æ¡ˆå­äº†ï¼">
                    <img src="snowman_eco.png" alt="Eco Snowman" class="xmas-icon" title="ç’°ä¿é›ªäººå¹«æ‚¨ç›¯è‘—æ•¸æ“šï¼">
                </div>

                <div class="d-flex align-items-center" id="last-update-container" style="display: none;">
                    <div class="status-indicator-container">
                        <i class="fas fa-check-circle me-1"></i>SYSTEM ONLINE
                        <span class="ms-2 text-muted small" id="last-update-time"></span>
                    </div>
                </div>
            </div>
        </header>

        <section class="control-panel mb-5">
            <div class="mb-4 text-center">
                <h5 style="color: var(--accent-gold); margin-bottom: 20px;"><i class="fas fa-gift me-2"></i>æœå°‹æ‚¨çš„å¹´åº¦æ¨™æ¡ˆç¦®ç‰©</h5>
                <input type="text" id="searchInput" class="form-control search-input-cyber" placeholder="è¼¸å…¥é—œéµå­—ï¼ŒæŒ–æ˜è–èª•å•†æ©Ÿ...">
            </div>
            <div class="d-flex flex-wrap justify-content-center align-items-center">
                <span class="text-muted me-3" style="font-size: 0.9rem; letter-spacing: 1px;">ç†±é–€é—œéµå­— ></span>
                <div id="keyword-badges" class="d-flex flex-wrap justify-content-center gap-2">
                    </div>
            </div>
        </section>

        <section class="row g-4 mb-5 justify-content-center mx-auto" style="max-width: 1200px;">
            <div class="col-md-4">
                <div class="stat-card-cyber">
                    <i class="fas fa-hat-santa fa-2x mb-2" style="color: var(--accent-amber); opacity: 0.8;"></i>
                    <span class="stat-num-digital num-red" id="todayCount">0</span>
                    <span class="stat-label">ä»Šæ—¥æ–°å¢å•†æ©Ÿ</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card-cyber">
                    <i class="fas fa-candy-cane fa-2x mb-2" style="color: var(--accent-cyan); opacity: 0.8;"></i>
                    <span class="stat-num-digital num-blue" id="historyCount">0</span>
                    <span class="stat-label">æ­·å²è³‡æ–™å­˜é‡</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card-cyber">
                    <i class="fas fa-star fa-2x mb-2" style="color: var(--accent-gold); opacity: 0.8;"></i>
                    <span class="stat-num-digital num-white" id="totalCount">0</span>
                    <span class="stat-label">ç›£æ§ç¸½ç­†æ•¸</span>
                </div>
            </div>
        </section>

        <ul class="nav nav-pills nav-pills-cyber mb-4 justify-content-center" id="pills-tab" role="tablist">
            <li class="nav-item"><button class="nav-link active" id="pills-today-tab" data-bs-toggle="pill" data-bs-target="#pills-today">ğŸ ä»Šæ—¥å¿«è¨Š</button></li>
            <li class="nav-item"><button class="nav-link" id="pills-history-tab" data-bs-toggle="pill" data-bs-target="#pills-history">ğŸ—„ï¸ æ­·å²æŸ¥è©¢</button></li>
            <li class="nav-item"><button class="nav-link" id="pills-expired-tab" data-bs-toggle="pill" data-bs-target="#pills-expired">â›„ å·²æˆªæ¨™æ¡ˆä»¶</button></li>
        </ul>

        <div class="tab-content mx-auto" style="max-width: 1000px;">
            <div class="tab-pane fade show active" id="pills-today">
                <div id="container-today">
                    <div class="loading-cyber"><i class="fas fa-snowflake fa-spin fa-3x mb-3"></i><br>æ­£åœ¨é›ªåœ°ä¸­æœå°‹æœ€æ–°è³‡æ–™...</div>
                </div>
            </div>
            <div class="tab-pane fade" id="pills-history">
                <div id="container-history">
                    <div class="loading-cyber"><i class="fas fa-snowflake fa-spin fa-3x mb-3"></i><br>æ­£åœ¨æŒ–æ˜æ­·å²è³‡æ–™åº«...</div>
                </div>
            </div>
            <div class="tab-pane fade" id="pills-expired">
                <div id="container-expired">
                    <div class="loading-cyber"><i class="fas fa-snowflake fa-spin fa-3x mb-3"></i><br>è®€å–å°å­˜è³‡æ–™...</div>
                </div>
            </div>
        </div>

    </div>

    <a href="index.html" class="btn-back-home">
        <i class="fas fa-arrow-left me-2"></i>è¿”å›ä¸»æˆ°æƒ…å®¤
    </a>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ==========================================
        // âš ï¸ è¨­å®šå€ï¼šèˆ‡ä¸»é å®Œå…¨ç›¸åŒ
        // ==========================================
        const sheetCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSL9csppWjrqt8UOwwOwDxI4WON1aujg78zBush52aLIUeFubdpp9Au93c6cgf_qDLuRRX2NP0OvTkJ/pub?gid=0&single=true&output=csv';
        const logCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSL9csppWjrqt8UOwwOwDxI4WON1aujg78zBush52aLIUeFubdpp9Au93c6cgf_qDLuRRX2NP0OvTkJ/pub?gid=469067754&single=true&output=csv'; 
        const historyCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSL9csppWjrqt8UOwwOwDxI4WON1aujg78zBush52aLIUeFubdpp9Au93c6cgf_qDLuRRX2NP0OvTkJ/pub?gid=175963084&single=true&output=csv'; 
        // ==========================================

        // â˜… æ–°å¢ï¼šç”¢ç”Ÿé›ªèŠ±ç‰¹æ•ˆ JS
        function createSnow() {
            const container = document.getElementById('snow-container');
            const snowCount = 50; // é›ªèŠ±æ•¸é‡
            for (let i = 0; i < snowCount; i++) {
                const snow = document.createElement('div');
                snow.className = 'snow';
                const size = Math.random() * 8 + 4 + 'px'; // éš¨æ©Ÿå¤§å° 4-12px
                snow.style.width = size; snow.style.height = size;
                snow.style.left = Math.random() * 100 + 'vw'; // éš¨æ©Ÿæ°´å¹³ä½ç½®
                snow.style.animationDuration = Math.random() * 10 + 5 + 's'; // 5-15ç§’é£„è½æ™‚é–“
                snow.style.animationDelay = Math.random() * 5 + 's'; // éš¨æ©Ÿå»¶é²
                snow.style.opacity = Math.random() * 0.7 + 0.3; // éš¨æ©Ÿé€æ˜åº¦
                container.appendChild(snow);
            }
        }

        // ==========================================
        // ä»¥ä¸‹ JavaScript é‚è¼¯èˆ‡ä¸»é å®Œå…¨ç›¸åŒ (é™¤äº† SweetAlert çš„é…è‰²)
        // ==========================================

        let allData = [];
        let historyDataCache = null;
        let todayStr = "";

        document.addEventListener('DOMContentLoaded', function() {
            createSnow(); // â˜… å•Ÿå‹•ä¸‹é›ª
            const dateObj = new Date();
            const year = dateObj.getFullYear() - 1911;
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            todayStr = `${year}/${month}/${day}`;
            
            fetchData();
            checkSystemStatus();
            
            document.getElementById('searchInput').addEventListener('input', function(e) {
                const keyword = e.target.value;
                document.querySelectorAll('.keyword-btn').forEach(btn => btn.classList.remove('active'));
                renderList(filterData(allData, 'today', keyword), 'container-today', false);
                renderList(filterData(allData, 'history', keyword), 'container-history', true);
                renderList(filterData(allData, 'expired', keyword), 'container-expired', true);
            });
        });

        function checkSystemStatus() {
            Papa.parse(logCsvUrl, {
                download: true, header: true,
                complete: function(results) {
                    const logs = results.data.filter(r => r.Time);
                    if (logs.length > 0) {
                        const lastLog = logs[logs.length - 1];
                        if (lastLog.Status === 'ERROR') {
                            const statusBar = document.getElementById('status-bar');
                            statusBar.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i> ç³»çµ±ç•°å¸¸è­¦å‘Šï¼š${lastLog.Message} (${lastLog.Time})`;
                            statusBar.style.display = 'block';
                        } else {
                            document.getElementById('last-update-container').style.display = 'flex';
                            document.getElementById('last-update-time').innerText = `(æ›´æ–°: ${lastLog.Time})`;
                        }
                    }
                }
            });
        }

        function fetchData() {
            Papa.parse(sheetCsvUrl, {
                download: true, header: true,
                complete: function(results) {
                    allData = results.data.filter(item => item.Title && item.Link).reverse();
                    updateStats();
                    renderKeywords();
                    renderList(filterData(allData, 'today', ''), 'container-today', false);
                    renderList(filterData(allData, 'history', ''), 'container-history', true);
                    renderList(filterData(allData, 'expired', ''), 'container-expired', true);
                },
                error: function(err) {
                    document.getElementById('container-today').innerHTML = '<div class="loading-cyber text-danger"><i class="fas fa-times-circle fa-2x mb-3"></i><br>è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥é€£ç·š</div>';
                }
            });
        }

        function renderKeywords() {
            const keywordMap = {};
            allData.forEach(item => {
                if (item.Tags) {
                    let parts = item.Tags.split('-');
                    let kw = parts.length > 1 ? parts[1] : item.Tags;
                    keywordMap[kw] = (keywordMap[kw] || 0) + 1;
                }
            });
            const container = document.getElementById('keyword-badges');
            let html = '';
            Object.entries(keywordMap).sort((a, b) => b[1] - a[1]).forEach(([key, count]) => {
                html += `<button class="keyword-btn" onclick="setSearch('${key}', this)">${key} <span class="keyword-badge-count">${count}</span></button>`;
            });
            container.innerHTML = html;
        }

        function setSearch(keyword, btnElement) {
            const searchInput = document.getElementById('searchInput');
            searchInput.value = keyword;
            searchInput.dispatchEvent(new Event('input'));
            document.querySelectorAll('.keyword-btn').forEach(btn => btn.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');
        }

        function filterData(data, type, keyword) {
            const now = new Date();
            now.setHours(0,0,0,0);
            return data.filter(item => {
                const itemDate = item.Date || "";
                const matchDate = itemDate.includes(todayStr);
                let isExpired = false;
                if (item.Deadline) {
                    const parts = item.Deadline.split('/');
                    if (parts.length === 3) {
                        const deadDate = new Date(parseInt(parts[0]) + 1911, parseInt(parts[1]) - 1, parseInt(parts[2]));
                        if (deadDate < now) isExpired = true;
                    }
                }
                if (type === 'today') { if (!matchDate) return false; } 
                else if (type === 'history') { if (matchDate || isExpired) return false; } 
                else if (type === 'expired') { if (!isExpired) return false; }
                if (keyword) {
                    const searchStr = (item.Title + item.Tags + item.Org + item.Source + item.Deadline).toLowerCase();
                    if (!searchStr.includes(keyword.toLowerCase())) return false;
                }
                return true;
            });
        }

        async function startAnalysis(btnId, title, org) {
            const btn = document.getElementById(btnId);
            const originalText = btn.innerHTML;
            btn.disabled = true;
            // â˜… ä¿®æ”¹ Loading åœ–ç¤ºç‚ºé›ªèŠ±
            btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> è–èª•ç²¾éˆæœå°‹ä¸­...`;

            try {
                if (!historyDataCache) {
                    await new Promise((resolve, reject) => {
                        Papa.parse(historyCsvUrl, {
                            download: true, header: true,
                            complete: function(results) {
                                historyDataCache = results.data;
                                console.log("æ­·å²è³‡æ–™åº«ä¸‹è¼‰å®Œæˆ", historyDataCache.length);
                                resolve();
                            },
                            error: function(err) { reject(err); }
                        });
                    });
                }
                await new Promise(r => setTimeout(r, 600));
                const result = performAnalysis(title, org);
                showResultModal(result, title);
            } catch (error) {
                console.error(error);
                // â˜… ä¿®æ”¹ SweetAlert é…è‰²
                Swal.fire({ icon: 'error', title: 'è®€å–å¤±æ•—', text: 'è«‹æª¢æŸ¥ History CSV é€£çµæ˜¯å¦æ­£ç¢º', background: '#2b1a1a', color: '#f0f0f0' });
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function performAnalysis(currentTitle, currentOrg) {
            const coreTitle = currentTitle.replace(/\d{3}å¹´åº¦?|\d{4}å¹´?/g, "").replace(/å…¬å‘Š|æ‹›æ¨™|æ¡ˆ|è¨ˆç•«|å‹å‹™|æ¡è³¼/g, "").trim();
            const matches = historyDataCache.filter(row => {
                const rowOrg = row['Org'] || row['æ©Ÿé—œåç¨±'];
                const rowTitle = row['Title'] || row['æ¨™æ¡ˆåç¨±'];
                return rowOrg === currentOrg && rowTitle && rowTitle.includes(coreTitle);
            });

            if (matches.length === 0) return null;

            matches.sort((a, b) => (b.Date || "").localeCompare(a.Date || ""));
            const lastCase = matches[0];
            let topWinner = "è³‡æ–™åº«ç„¡ç´€éŒ„";
            const winners = matches.map(m => m.Winner || m.å¾—æ¨™å» å•†).filter(w => w);
            if(winners.length > 0) {
                const counts = {};
                winners.forEach(w => counts[w] = (counts[w] || 0) + 1);
                topWinner = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
            }

            return {
                count: matches.length,
                lastDate: lastCase.Date,
                lastTitle: lastCase.Title || lastCase.æ¨™æ¡ˆåç¨±,
                lastAmount: lastCase.Budget || lastCase.é ç®—é‡‘é¡,
                lastWinner: lastCase.Winner || lastCase.å¾—æ¨™å» å•† || "ç„¡è³‡æ–™",
                dominantWinner: topWinner
            };
        }

        function showResultModal(data, currentTitle) {
            if (!data) {
                Swal.fire({
                    icon: 'info', title: 'æŸ¥ç„¡æ­·å²é—œè¯',
                    text: 'é€™ä¼¼ä¹æ˜¯ä¸€å€‹å…¨æ–°çš„æ¡ˆä»¶ï¼Œéå»è³‡æ–™åº«ä¸­æ²’æœ‰ç›¸ä¼¼ç´€éŒ„ã€‚',
                    // â˜… ä¿®æ”¹ SweetAlert é…è‰²ç‚ºè–èª•ç´…ç¶ 
                    confirmButtonColor: '#165b33',
                    background: '#2b1a1a', color: '#f0f0f0'
                });
                return;
            }
            Swal.fire({
                title: 'ğŸ… è–èª•æˆ°æƒ…åˆ†æå ±å‘Š', // â˜… ä¿®æ”¹æ¨™é¡Œ
                html: `
                    <div style="text-align: left; font-size: 0.95rem; color: #f0f0f0;">
                        <p class="mb-2"><strong>ğŸ ç›®å‰æ¨™æ¡ˆï¼š</strong><br>${currentTitle}</p>
                        <hr style="border-color: var(--accent-gold);">
                        <p class="mb-1"><strong>ğŸ” æ­·å²é—œè¯ï¼š</strong> ç™¼ç¾ <span style="color:var(--accent-amber); font-weight:bold;">${data.count}</span> ç­†ç›¸ä¼¼æ¡ˆä»¶</p>
                        <p class="mb-1"><strong>ğŸ“… æœ€è¿‘ä¸€æ¬¡ï¼š</strong> ${data.lastDate}</p>
                        <p class="mb-1"><strong>ğŸ“ æ­·å²æ¡ˆåï¼š</strong> ${data.lastTitle}</p>
                        <p class="mb-1"><strong>ğŸ’° æ­·å²é‡‘é¡ï¼š</strong> <span style="color:var(--accent-gold); font-weight:bold;">${data.lastAmount}</span></p>
                        <div class="mt-3 p-2 rounded border" style="background: rgba(22, 91, 51, 0.2); border-color: var(--accent-cyan);">
                            <p class="mb-0"><strong>ğŸ† æ­·å¹´éœ¸ä¸»ï¼š</strong> <span style="color:var(--accent-cyan); font-weight:bold;">${data.dominantWinner}</span></p>
                            <small style="color:var(--text-muted);">(å‡ºç¾é »ç‡æœ€é«˜çš„å» å•†)</small>
                        </div>
                    </div>
                `,
                icon: 'success',
                confirmButtonText: 'äº†è§£æƒ…è³‡', confirmButtonColor: '#165b33', // â˜… ä¿®æ”¹æŒ‰éˆ•é¡è‰²
                background: '#2b1a1a', color: '#f0f0f0'
            });
        }

        function renderList(data, containerId, groupByDate) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (data.length === 0) {
                // â˜… ä¿®æ”¹ç©ºç‹€æ…‹åœ–ç¤º
                container.innerHTML = '<div class="empty-state"><i class="fas fa-gift fa-3x mb-3"></i><br>ç›®å‰æ²’æœ‰è³‡æ–™ç¦®ç‰©</div>';
                return;
            }

            let html = '';
            let lastDate = '';

            data.forEach((item, index) => {
                if (groupByDate && item.Date !== lastDate) {
                    html += `<div class="date-separator"><span class="date-text"><i class="far fa-calendar-alt me-2"></i>${item.Date}</span></div>`;
                    lastDate = item.Date;
                }

                const isPis = item.Source && item.Source.includes("æ¡è³¼");
                const borderClass = isPis ? 'source-pis' : 'source-env';
                const btnId = `analyze-${containerId}-${index}`;
                const orgName = item.Org || item.Source; 

                html += `
                    <div class="tender-card-tech ${borderClass}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="mb-2">
                                    <span class="org-badge-tech me-2"><i class="fas fa-building me-1"></i>${orgName}</span>
                                    <span class="tag-badge-tech"><i class="fas fa-tag me-1"></i>${item.Tags || 'ä¸€èˆ¬'}</span>
                                    <button id="${btnId}" class="btn-analyze-tech ms-3" onclick="startAnalysis('${btnId}', '${item.Title}', '${item.Org}')">
                                        <i class="fas fa-chart-line me-1"></i>æˆ°æƒ…åˆ†æ
                                    </button>
                                </div>
                                <a href="${item.Link}" target="_blank" class="tender-title-tech">${item.Title}</a>
                                <div class="info-row-tech">
                                    ${item.Budget ? `<div class="info-item-tech"><i class="fas fa-coins"></i><span class="budget-text">$${item.Budget}</span></div>` : ''}
                                    ${item.Deadline ? `<div class="info-item-tech"><i class="fas fa-hourglass-half"></i><span class="deadline-text">æˆªæ­¢: ${item.Deadline}</span></div>` : ''}
                                    ${!groupByDate ? `<div class="info-item-tech"><i class="far fa-clock"></i>${item.Date}</div>` : ''}
                                </div>
                            </div>
                            <div class="ms-3 d-none d-sm-block align-self-center">
                                <a href="${item.Link}" target="_blank" class="btn-view-tech">æŸ¥çœ‹å…¬å‘Š</a>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function updateStats() {
            document.getElementById('totalCount').innerText = allData.length;
            const todayCount = allData.filter(item => item.Date && item.Date.includes(todayStr)).length;
            document.getElementById('todayCount').innerText = todayCount;
            document.getElementById('historyCount').innerText = allData.length - todayCount;
        }
    </script>
</body>
</html>
