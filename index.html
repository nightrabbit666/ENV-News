<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç’°å¢ƒéƒ¨èˆ‡æ¨™æ¡ˆç›£æ§å„€è¡¨æ¿</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; }
        .header { background: linear-gradient(135deg, #0062E6, #33AEFF); color: white; padding: 2rem 0; margin-bottom: 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .card-custom { border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); background: white; margin-bottom: 12px; transition: transform 0.2s; border-left: 5px solid transparent; }
        .card-custom:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .source-pis { border-left-color: #ffc107; } 
        .source-env { border-left-color: #28a745; }
        .badge-tag { font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; font-weight: normal;}
        .bg-pis { background-color: #fff3cd; color: #856404; }
        .bg-env { background-color: #d4edda; color: #155724; }
        .news-link { text-decoration: none; color: #2c3e50; font-weight: 600; font-size: 1.1rem; display: block; margin-bottom: 8px; }
        .news-link:hover { color: #0062E6; }
        .search-bar { border-radius: 50px; padding: 12px 25px; border: 1px solid #ced4da; width: 100%; max-width: 500px; }
        .nav-pills .nav-link { border-radius: 50px; padding: 8px 20px; font-weight: 600; color: #6c757d; margin-right: 10px;}
        .nav-pills .nav-link.active { background-color: #0062E6; color: white; }
        .date-separator { display: flex; align-items: center; margin: 25px 0 15px 0; color: #adb5bd; font-size: 0.9rem; font-weight: bold; }
        .date-separator::before, .date-separator::after { content: ""; flex: 1; border-bottom: 1px solid #dee2e6; }
        .date-text { background-color: #e9ecef; color: #495057; padding: 5px 15px; border-radius: 20px; }
        .info-row { font-size: 0.9rem; color: #666; display: flex; flex-wrap: wrap; gap: 15px; }
        .info-item { display: flex; align-items: center; }
        .info-item i { margin-right: 5px; color: #adb5bd; }
        .budget-text { color: #dc3545; font-weight: bold; }
        .loading { text-align: center; padding: 50px; color: #6c757d; }
        
        /* ç³»çµ±ç‹€æ…‹æ¢ */
        #system-status { display: none; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div class="header text-center">
        <h1 class="fw-bold"><i class="fas fa-search-dollar me-2"></i>æ¨™æ¡ˆèˆ‡æ–°èæˆ°æƒ…å®¤</h1>
        <p class="opacity-75 mb-0">å³æ™‚ç›£æ§ï¼šè³‡æºå¾ªç’°ç½² / ç’°å¢ƒç®¡ç†ç½² / æ”¿åºœæ¡è³¼ç¶²</p>
    </div>

    <div class="container" style="max-width: 900px;">
        
        <div id="system-status" class="alert alert-dismissible fade show" role="alert">
            <span id="status-icon"></span> 
            <strong id="status-title"></strong> 
            <span id="status-msg"></span>
            <span id="status-time" class="float-end small text-muted"></span>
        </div>

        <div class="d-flex justify-content-center mb-4">
            <input type="text" id="searchInput" class="search-bar" placeholder="ğŸ” æœå°‹æ¨™é¡Œã€æ©Ÿé—œã€æˆªæ­¢æ—¥...">
        </div>

        <div class="row mb-4 text-center g-3">
            <div class="col-4"><div class="p-3 bg-white rounded shadow-sm"><h2 id="todayCount" class="text-danger fw-bold mb-0">0</h2><small class="text-muted">ä»Šæ—¥æ–°å¢</small></div></div>
            <div class="col-4"><div class="p-3 bg-white rounded shadow-sm"><h2 id="historyCount" class="text-primary fw-bold mb-0">0</h2><small class="text-muted">æ­·å²å­˜é‡</small></div></div>
            <div class="col-4"><div class="p-3 bg-white rounded shadow-sm"><h2 id="totalCount" class="text-dark fw-bold mb-0">0</h2><small class="text-muted">ç¸½è³‡æ–™æ•¸</small></div></div>
        </div>

        <ul class="nav nav-pills mb-4 justify-content-center" id="pills-tab" role="tablist">
            <li class="nav-item"><button class="nav-link active" id="pills-today-tab" data-bs-toggle="pill" data-bs-target="#pills-today">ğŸ”¥ ä»Šæ—¥å¿«è¨Š</button></li>
            <li class="nav-item"><button class="nav-link" id="pills-history-tab" data-bs-toggle="pill" data-bs-target="#pills-history">ğŸ—„ï¸ æ­·å²æŸ¥è©¢å…§å®¹</button></li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane fade show active" id="pills-today"><div id="container-today"><div class="loading"><i class="fas fa-spinner fa-spin fa-2x mb-2"></i><br>è®€å–ä¸­...</div></div></div>
            <div class="tab-pane fade" id="pills-history"><div id="container-history"><div class="loading"><i class="fas fa-spinner fa-spin fa-2x mb-2"></i><br>è®€å–ä¸­...</div></div></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // âš ï¸ 1. æ–°èè³‡æ–™ CSV (åŸæœ¬çš„)
        const sheetCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSL9csppWjrqt8UOwwOwDxI4WON1aujg78zBush52aLIUeFubdpp9Au93c6cgf_qDLuRRX2NP0OvTkJ/pub?output=csv';
        
        // âš ï¸ 2. ç³»çµ±æ—¥èªŒ CSV (æ–°å¢çš„ logs å·¥ä½œè¡¨ç™¼å¸ƒé€£çµ)
        // è«‹è¨˜å¾—å» Google Sheets -> æª”æ¡ˆ -> å…±ç”¨ -> ç™¼ä½ˆåˆ°ç¶²è·¯ -> é¸æ“‡ "logs" -> CSV
        const logCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSL9csppWjrqt8UOwwOwDxI4WON1aujg78zBush52aLIUeFubdpp9Au93c6cgf_qDLuRRX2NP0OvTkJ/pubhtml'; 

        let allData = [];
        let todayStr = "";

        document.addEventListener('DOMContentLoaded', function() {
            const dateObj = new Date();
            const year = dateObj.getFullYear() - 1911;
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            todayStr = `${year}/${month}/${day}`;
            
            fetchData();
            checkSystemStatus(); // æª¢æŸ¥ç³»çµ±å¥åº·åº¦
            
            document.getElementById('searchInput').addEventListener('input', function(e) {
                const keyword = e.target.value;
                renderList(filterData(allData, true, keyword), 'container-today', false);
                renderList(filterData(allData, false, keyword), 'container-history', true);
            });
        });

        // æª¢æŸ¥ç³»çµ±ç‹€æ…‹ (è®€å– logs)
        function checkSystemStatus() {
            Papa.parse(logCsvUrl, {
                download: true,
                header: true,
                complete: function(results) {
                    const logs = results.data.filter(r => r.Time);
                    if (logs.length > 0) {
                        // å–æœ€æ–°ä¸€ç­†
                        const lastLog = logs[logs.length - 1];
                        const statusBox = document.getElementById('system-status');
                        const statusIcon = document.getElementById('status-icon');
                        const statusTitle = document.getElementById('status-title');
                        const statusMsg = document.getElementById('status-msg');
                        const statusTime = document.getElementById('status-time');

                        statusBox.style.display = 'block';
                        statusTime.innerText = `æ›´æ–°æ–¼: ${lastLog.Time}`;

                        if (lastLog.Status === 'ERROR') {
                            // ç´…è‰²è­¦å ±
                            statusBox.className = 'alert alert-danger';
                            statusIcon.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>';
                            statusTitle.innerText = 'ç³»çµ±ç•°å¸¸ï¼';
                            statusMsg.innerText = lastLog.Message; // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                        } else {
                            // ç¶ è‰²æ­£å¸¸
                            statusBox.className = 'alert alert-success';
                            statusIcon.innerHTML = '<i class="fas fa-check-circle me-2"></i>';
                            statusTitle.innerText = 'ç³»çµ±é‹è¡Œæ­£å¸¸';
                            statusMsg.innerText = lastLog.Message;
                        }
                    }
                }
            });
        }

        function fetchData() {
            Papa.parse(sheetCsvUrl, {
                download: true,
                header: true,
                complete: function(results) {
                    allData = results.data.filter(item => item.Title && item.Link);
                    allData.reverse();
                    updateStats();
                    renderList(filterData(allData, true, ''), 'container-today', false);
                    renderList(filterData(allData, false, ''), 'container-history', true);
                }
            });
        }

        function filterData(data, isToday, keyword) {
            return data.filter(item => {
                const itemDate = item.Date || "";
                const matchDate = itemDate.includes(todayStr); 
                if (isToday && !matchDate) return false; 
                if (!isToday && matchDate) return false; 
                if (keyword) {
                    const searchStr = (item.Title + item.Tags + item.Org + item.Source).toLowerCase();
                    if (!searchStr.includes(keyword.toLowerCase())) return false;
                }
                return true;
            });
        }

        function renderList(data, containerId, groupByDate) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = '<div class="empty-state">ç„¡è³‡æ–™</div>';
                return;
            }

            let html = '';
            let lastDate = '';

            data.forEach(item => {
                if (groupByDate && item.Date !== lastDate) {
                    html += `<div class="date-separator"><span class="date-text">${item.Date}</span></div>`;
                    lastDate = item.Date;
                }

                const isPis = item.Source && item.Source.includes("æ¡è³¼");
                const borderClass = isPis ? 'source-pis' : 'source-env';
                const badgeClass = isPis ? 'bg-pis' : 'bg-env';
                
                const orgName = item.Org || item.Source; 
                const budget = item.Budget ? `<span class="budget-text">$${item.Budget}</span>` : '';
                const deadline = item.Deadline ? `<span class="text-danger">æˆªæ­¢: ${item.Deadline}</span>` : '';

                html += `
                    <div class="card-custom p-3 ${borderClass}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="mb-2">
                                    <span class="badge ${badgeClass} badge-tag text-dark">${orgName}</span>
                                    <span class="badge bg-light text-secondary border badge-tag ms-1">${item.Tags || 'ä¸€èˆ¬'}</span>
                                </div>
                                <a href="${item.Link}" target="_blank" class="news-link">${item.Title}</a>
                                
                                <div class="info-row">
                                    ${budget ? `<div class="info-item"><i class="fas fa-money-bill-wave"></i>${budget}</div>` : ''}
                                    ${deadline ? `<div class="info-item"><i class="fas fa-hourglass-end"></i>${deadline}</div>` : ''}
                                    ${!groupByDate ? `<div class="info-item"><i class="far fa-clock"></i>${item.Date}</div>` : ''}
                                </div>
                            </div>
                            <div class="ms-3 d-none d-sm-block">
                                <a href="${item.Link}" target="_blank" class="btn btn-outline-secondary btn-sm rounded-pill px-3">æŸ¥çœ‹</a>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function updateStats() {
            document.getElementById('totalCount').innerText = allData.length;
            const todayCount = allData.filter(item => item.Date && item.Date.includes(todayStr)).length;
            document.getElementById('todayCount').innerText = todayCount;
            document.getElementById('historyCount').innerText = allData.length - todayCount;
        }
    </script>
</body>
</html>
