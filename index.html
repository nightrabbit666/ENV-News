<!DOCTYPE html>
<html lang="zh-Hant" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¿åºœæ¨™æ¡ˆæˆ°æƒ…å®¤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;600;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        /* === å…¨å±€è®Šæ•¸å®šç¾© === */
        :root {
            --bg-dark: #0f172a;       /* æ·±æµ·è»è—èƒŒæ™¯ */
            --bg-panel: #1e293b;      /* é¢æ¿èƒŒæ™¯ */
            --accent-cyan: #0ea5e9;   /* éœ“è™¹é’å¼·èª¿è‰² */
            --accent-amber: #f59e0b;  /* ç¥ç€è­¦ç¤ºè‰² */
            --accent-red: #ff3366;    /* æ•¸ç¢¼ç´… */
            --text-bright: #f8fafc;   /* é«˜äº®æ–‡å­— */
            --text-muted: #94a3b8;    /* æ¬¡è¦æ–‡å­— */
            --font-tech: 'Chakra Petch', sans-serif;
            --font-digital: 'Orbitron', sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-bright);
            font-family: var(--font-tech);
            min-height: 100vh;
            background-image: linear-gradient(rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.9)), url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%230ea5e9' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            padding-bottom: 50px;
        }

        /* === ç³»çµ±ç‹€æ…‹æ¢ === */
        #status-bar { 
            display: none; 
            padding: 8px 20px; 
            font-size: 0.9rem; 
            text-align: center; 
            color: white;
            font-weight: bold;
            background-color: var(--accent-red);
            box-shadow: 0 0 15px var(--accent-red);
        }
        .status-indicator-container {
            font-family: var(--font-digital);
            font-size: 0.9rem;
            color: #10b981;
            text-shadow: 0 0 5px #10b981;
        }

        /* === 1. é ‚éƒ¨æ¨™é¡Œåˆ— === */
        .war-room-header {
            padding: 1.5rem 0;
            border-bottom: 1px solid rgba(14, 165, 233, 0.2);
            margin-bottom: 2rem;
            background: linear-gradient(90deg, rgba(15,23,42,0) 0%, rgba(14,165,233,0.1) 50%, rgba(15,23,42,0) 100%);
        }
        .header-title {
            font-family: var(--font-digital);
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            text-shadow: 0 0 10px rgba(14, 165, 233, 0.5);
        }

        /* === 2. æ§åˆ¶å€ (æœå°‹èˆ‡éæ¿¾) === */
        .control-panel {
            background: rgba(30, 41, 59, 0.5);
            padding: 2rem;
            border-radius: 16px;
            border: 1px solid rgba(14, 165, 233, 0.1);
            backdrop-filter: blur(10px);
            max-width: 900px;
            margin: 0 auto 3rem auto;
        }
        .search-input-cyber {
            background-color: rgba(15, 23, 42, 0.8);
            border: 1px solid var(--accent-cyan);
            color: var(--text-bright);
            padding: 15px 25px;
            font-size: 1.1rem;
            border-radius: 50px;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(14, 165, 233, 0.2);
        }
        .search-input-cyber:focus {
            background-color: rgba(15, 23, 42, 1);
            box-shadow: 0 0 30px rgba(14, 165, 233, 0.6);
            border-color: var(--accent-cyan);
            color: white;
            outline: none;
        }
        .keyword-btn {
            background: transparent;
            border: 1px solid var(--text-muted);
            color: var(--text-muted);
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            font-family: var(--font-digital);
            letter-spacing: 1px;
            margin: 4px;
        }
        .keyword-btn:hover, .keyword-btn.active {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
            box-shadow: 0 0 15px rgba(14, 165, 233, 0.4);
            background: rgba(14, 165, 233, 0.1);
        }
        .keyword-badge-count {
            background-color: rgba(14, 165, 233, 0.2);
            color: var(--accent-cyan);
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
        }

        /* === 3. çµ±è¨ˆæ•¸æ“šå€ (é›»å­é˜é¢¨æ ¼) === */
        .stat-card-cyber {
            background: var(--bg-panel);
            border: 1px solid rgba(14, 165, 233, 0.15);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s;
            height: 100%;
        }
        .stat-card-cyber:hover {
            transform: translateY(-5px);
            border-color: var(--accent-cyan);
            box-shadow: 0 0 15px rgba(14, 165, 233, 0.2) inset;
        }
        .stat-card-cyber::after { /* æƒæç·š */
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(transparent 50%, rgba(14, 165, 233, 0.05) 50%);
            background-size: 100% 4px; pointer-events: none;
        }
        .stat-num-digital {
            font-family: var(--font-digital);
            font-size: 2.8rem;
            font-weight: 700;
            display: block;
            margin-bottom: 10px;
            text-shadow: 0 0 10px currentColor;
        }
        .num-red { color: var(--accent-red); }
        .num-blue { color: var(--accent-cyan); }
        .num-white { color: var(--text-bright); }
        .stat-label { color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; font-size: 0.85rem; }

        /* === 4. å°èˆªåˆ†é  (è† å›Šç‹€) === */
        .nav-pills-cyber .nav-link {
            color: var(--text-muted);
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(14, 165, 233, 0.2);
            border-radius: 50px;
            padding: 10px 25px;
            margin: 0 5px;
            font-family: var(--font-tech);
            letter-spacing: 1px;
            transition: all 0.3s;
        }
        .nav-pills-cyber .nav-link:hover { color: var(--accent-cyan); border-color: var(--accent-cyan); }
        .nav-pills-cyber .nav-link.active {
            background: var(--accent-cyan); color: var(--bg-dark); font-weight: 700;
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.6); border-color: var(--accent-cyan);
        }

        /* === 5. è³‡æ–™åˆ—è¡¨ (é«˜ç§‘æŠ€é¢æ¿å¡ç‰‡) === */
        .tender-card-tech {
            background: var(--bg-panel);
            border: 1px solid rgba(14, 165, 233, 0.1);
            border-left: 4px solid;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 20px;
            position: relative;
            transition: all 0.3s;
        }
        .tender-card-tech:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.3), 0 0 20px rgba(14, 165, 233, 0.1) inset;
            transform: scale(1.01);
            border-color: var(--accent-cyan);
        }
        .source-pis { border-left-color: var(--accent-amber); } /* æ¡è³¼ç¶²-ç¥ç€è‰² */
        .source-env { border-left-color: var(--accent-cyan); }  /* ç’°å¢ƒéƒ¨-éœ“è™¹é’ */

        .org-badge-tech {
            background: rgba(14, 165, 233, 0.15); color: var(--accent-cyan);
            border: 1px solid var(--accent-cyan); padding: 4px 10px; border-radius: 4px;
            font-size: 0.8rem; text-transform: uppercase;
        }
        .source-pis .org-badge-tech {
            background: rgba(245, 158, 11, 0.15); color: var(--accent-amber); border-color: var(--accent-amber);
        }
        .tag-badge-tech {
             background: rgba(255, 255, 255, 0.1); color: var(--text-muted);
             border: 1px solid var(--text-muted); padding: 4px 10px; border-radius: 4px;
             font-size: 0.8rem; margin-left: 8px;
        }

        .tender-title-tech {
            font-size: 1.25rem; color: var(--text-bright); text-decoration: none;
            display: block; margin: 12px 0; font-weight: 600;
        }
        .tender-title-tech:hover { color: var(--accent-cyan); text-shadow: 0 0 10px rgba(14, 165, 233, 0.5); }

        .info-row-tech { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px; align-items: center; }
        .info-item-tech {
            background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(14, 165, 233, 0.2);
            padding: 6px 12px; border-radius: 30px; font-size: 0.9rem; color: var(--text-muted);
            display: flex; align-items: center;
        }
        .info-item-tech i { margin-right: 8px; color: var(--accent-cyan); opacity: 0.8; }
        .budget-text { color: var(--accent-amber); font-family: var(--font-digital); font-weight: 700; text-shadow: 0 0 5px rgba(245, 158, 11, 0.5);}
        .deadline-text { color: var(--accent-red); font-weight: 600; }

        /* åˆ†ææŒ‰éˆ• */
        .btn-analyze-tech {
            background: linear-gradient(90deg, var(--accent-cyan), #2563eb); border: none; color: white;
            padding: 6px 15px; border-radius: 30px; font-size: 0.85rem; cursor: pointer; transition: all 0.3s;
            display: inline-flex; align-items: center; box-shadow: 0 0 10px rgba(14, 165, 233, 0.4);
        }
        .btn-analyze-tech:hover { box-shadow: 0 0 20px rgba(14, 165, 233, 0.7); transform: scale(1.05); }
        .btn-analyze-tech:disabled { background: #475569; box-shadow: none; cursor: not-allowed; opacity: 0.7; transform: none;}
        .btn-view-tech {
             background: transparent; border: 1px solid var(--accent-cyan); color: var(--accent-cyan);
             padding: 6px 15px; border-radius: 30px; font-size: 0.85rem; text-decoration: none; transition: all 0.3s;
        }
        .btn-view-tech:hover { background: var(--accent-cyan); color: var(--bg-dark); box-shadow: 0 0 15px rgba(14, 165, 233, 0.5); }

        /* å…¶ä»–å…ƒç´  */
        .date-separator { display: flex; align-items: center; margin: 30px 0 20px 0; color: var(--text-muted); font-family: var(--font-digital); }
        .date-separator::before, .date-separator::after { content: ""; flex: 1; border-bottom: 1px solid rgba(14, 165, 233, 0.2); }
        .date-text { background-color: var(--bg-panel); padding: 5px 15px; border-radius: 20px; border: 1px solid rgba(14, 165, 233, 0.2); }
        .loading-cyber { text-align: center; padding: 60px; color: var(--accent-cyan); opacity: 0.8; }
        .empty-state { text-align: center; padding: 80px; color: var(--text-muted); opacity: 0.6; }
        .spinner-border-sm { width: 0.8rem; height: 0.8rem; border-width: 0.15em; margin-right: 5px; }
    </style>
</head>
<body>

    <div id="status-bar"></div>

    <div class="container-fluid px-lg-5">
        <header class="war-room-header d-flex justify-content-between align-items-center">
            <h1 class="header-title mb-0">
                <i class="fas fa-satellite-dish me-2 text-info"></i>æ¨™æ¡ˆæˆ°æƒ…å®¤
            </h1>
            <div class="d-flex align-items-center" id="last-update-container" style="display: none;">
                <div class="status-indicator-container">
                    <i class="fas fa-check-circle me-1"></i>SYSTEM ONLINE
                    <span class="ms-2 text-muted small" id="last-update-time"></span>
                </div>
            </div>
            <div class="text-center mb-4">
    <a href="christmas.html" class="btn btn-danger rounded-pill px-4 py-2" style="background: linear-gradient(45deg, #d42426, #f8b229); border: none; font-weight: bold;">
        <i class="fas fa-gift me-2"></i>é»æˆ‘é€²å…¥è–èª•ç‰¹è¼¯é é¢
    </a>
</div>
        </header>

        <section class="control-panel mb-5">
            <div class="mb-4">
                <input type="text" id="searchInput" class="form-control search-input-cyber" placeholder="è«‹è¼¸å…¥é—œéµå­—é€²è¡Œæˆ°æƒ…æœç´¢...">
            </div>
            <div class="d-flex flex-wrap justify-content-center align-items-center">
                <span class="text-muted me-3" style="font-size: 0.9rem; letter-spacing: 1px;">å¿«é€Ÿéæ¿¾ ></span>
                <div id="keyword-badges" class="d-flex flex-wrap justify-content-center gap-2">
                    </div>
            </div>
        </section>

        <section class="row g-4 mb-5 justify-content-center mx-auto" style="max-width: 1200px;">
            <div class="col-md-4">
                <div class="stat-card-cyber">
                    <span class="stat-num-digital num-red" id="todayCount">0</span>
                    <span class="stat-label"><i class="fas fa-bolt me-1"></i> ä»Šæ—¥æ–°å¢å•†æ©Ÿ</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card-cyber">
                    <span class="stat-num-digital num-blue" id="historyCount">0</span>
                    <span class="stat-label"><i class="fas fa-database me-1"></i> æ­·å²è³‡æ–™å­˜é‡</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card-cyber">
                    <span class="stat-num-digital num-white" id="totalCount">0</span>
                    <span class="stat-label"><i class="fas fa-chart-pie me-1"></i> ç›£æ§ç¸½ç­†æ•¸</span>
                </div>
            </div>
        </section>

        <ul class="nav nav-pills nav-pills-cyber mb-4 justify-content-center" id="pills-tab" role="tablist">
            <li class="nav-item"><button class="nav-link active" id="pills-today-tab" data-bs-toggle="pill" data-bs-target="#pills-today">ğŸ”¥ ä»Šæ—¥å¿«è¨Š</button></li>
            <li class="nav-item"><button class="nav-link" id="pills-history-tab" data-bs-toggle="pill" data-bs-target="#pills-history">ğŸ—„ï¸ æ­·å²æŸ¥è©¢</button></li>
            <li class="nav-item"><button class="nav-link" id="pills-expired-tab" data-bs-toggle="pill" data-bs-target="#pills-expired">ğŸ’€ å·²æˆªæ¨™æ¡ˆä»¶</button></li>
        </ul>

        <div class="tab-content mx-auto" style="max-width: 1000px;">
            <div class="tab-pane fade show active" id="pills-today">
                <div id="container-today">
                    <div class="loading-cyber"><i class="fas fa-satellite fa-spin fa-3x mb-3"></i><br>æ­£åœ¨å»ºç«‹å®‰å…¨é€£ç·šï¼ŒåŒæ­¥æˆ°æƒ…è³‡æ–™...</div>
                </div>
            </div>
            <div class="tab-pane fade" id="pills-history">
                <div id="container-history">
                    <div class="loading-cyber"><i class="fas fa-satellite fa-spin fa-3x mb-3"></i><br>æ­£åœ¨è®€å–æ­·å²è³‡æ–™åº«...</div>
                </div>
            </div>
            <div class="tab-pane fade" id="pills-expired">
                <div id="container-expired">
                    <div class="loading-cyber"><i class="fas fa-satellite fa-spin fa-3x mb-3"></i><br>è®€å–å°å­˜è³‡æ–™...</div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ==========================================
        // âš ï¸ è¨­å®šå€ï¼šè«‹å¡«å…¥æ‚¨çš„ Google Sheets CSV é€£çµ (ç¶­æŒåŸæ¨£)
        // ==========================================
        
        const sheetCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSL9csppWjrqt8UOwwOwDxI4WON1aujg78zBush52aLIUeFubdpp9Au93c6cgf_qDLuRRX2NP0OvTkJ/pub?gid=0&single=true&output=csv';
        const logCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSL9csppWjrqt8UOwwOwDxI4WON1aujg78zBush52aLIUeFubdpp9Au93c6cgf_qDLuRRX2NP0OvTkJ/pub?gid=469067754&single=true&output=csv'; 
        const historyCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSL9csppWjrqt8UOwwOwDxI4WON1aujg78zBush52aLIUeFubdpp9Au93c6cgf_qDLuRRX2NP0OvTkJ/pub?gid=175963084&single=true&output=csv'; 

        // ==========================================

        let allData = [];
        let historyDataCache = null;
        let todayStr = "";

        // åˆå§‹åŒ– (ç¶­æŒåŸæ¨£)
        document.addEventListener('DOMContentLoaded', function() {
            const dateObj = new Date();
            const year = dateObj.getFullYear() - 1911;
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            todayStr = `${year}/${month}/${day}`;
            
            fetchData();
            checkSystemStatus();
            
            document.getElementById('searchInput').addEventListener('input', function(e) {
                const keyword = e.target.value;
                document.querySelectorAll('.keyword-btn').forEach(btn => btn.classList.remove('active'));
                // å°‡ true æ”¹ç‚º 'today'ï¼Œå°‡ false æ”¹ç‚º 'history'
                renderList(filterData(allData, 'today', keyword), 'container-today', false);
                renderList(filterData(allData, 'history', keyword), 'container-history', true);
                renderList(filterData(allData, 'expired', keyword), 'container-expired', true);
            });
        });

        // è®€å–æ—¥èªŒ (ç¶­æŒåŸæ¨£ï¼Œåƒ…ä¿®æ”¹é¡¯ç¤ºæ¨£å¼)
        function checkSystemStatus() {
            Papa.parse(logCsvUrl, {
                download: true, header: true,
                complete: function(results) {
                    const logs = results.data.filter(r => r.Time);
                    if (logs.length > 0) {
                        const lastLog = logs[logs.length - 1];
                        if (lastLog.Status === 'ERROR') {
                            const statusBar = document.getElementById('status-bar');
                            statusBar.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i> ç³»çµ±ç•°å¸¸è­¦å‘Šï¼š${lastLog.Message} (${lastLog.Time})`;
                            statusBar.style.display = 'block';
                        } else {
                            document.getElementById('last-update-container').style.display = 'flex';
                            document.getElementById('last-update-time').innerText = `(æ›´æ–°: ${lastLog.Time})`;
                        }
                    }
                }
            });
        }

        // è®€å–ä¸»è³‡æ–™ (ç¶­æŒåŸæ¨£)
        function fetchData() {
            Papa.parse(sheetCsvUrl, {
                download: true, header: true,
                complete: function(results) {
                    allData = results.data.filter(item => item.Title && item.Link).reverse();
                    updateStats();
                    renderKeywords();
                    // å°‡ true æ”¹ç‚º 'today'ï¼Œå°‡ false æ”¹ç‚º 'history'
                    renderList(filterData(allData, 'today', ''), 'container-today', false);
                    renderList(filterData(allData, 'history', ''), 'container-history', true);
                    renderList(filterData(allData, 'expired', ''), 'container-expired', true);
                },
                error: function(err) {
                    document.getElementById('container-today').innerHTML = '<div class="loading-cyber text-danger"><i class="fas fa-times-circle fa-2x mb-3"></i><br>è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥é€£ç·š</div>';
                }
            });
        }

        // ç”¢ç”Ÿé—œéµå­—æŒ‰éˆ• (ä¿®æ”¹ç‚ºæ–°æ¨£å¼)
        function renderKeywords() {
            const keywordMap = {};
            allData.forEach(item => {
                if (item.Tags) {
                    let parts = item.Tags.split('-');
                    let kw = parts.length > 1 ? parts[1] : item.Tags;
                    keywordMap[kw] = (keywordMap[kw] || 0) + 1;
                }
            });
            
            const container = document.getElementById('keyword-badges');
            let html = '';
            Object.entries(keywordMap).sort((a, b) => b[1] - a[1]).forEach(([key, count]) => {
                html += `<button class="keyword-btn" onclick="setSearch('${key}', this)">${key} <span class="keyword-badge-count">${count}</span></button>`;
            });
            container.innerHTML = html;
        }

        // é»æ“Šé—œéµå­—æœå°‹ (ç¶­æŒåŸæ¨£)
        function setSearch(keyword, btnElement) {
            const searchInput = document.getElementById('searchInput');
            searchInput.value = keyword;
            searchInput.dispatchEvent(new Event('input'));
            document.querySelectorAll('.keyword-btn').forEach(btn => btn.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');
        }

        // ç¯©é¸é‚è¼¯ (ç¶­æŒåŸæ¨£)
        function filterData(data, type, keyword) {
            const now = new Date();
            now.setHours(0,0,0,0);
            return data.filter(item => {
                const itemDate = item.Date || "";
                const matchDate = itemDate.includes(todayStr);
                let isExpired = false;
                if (item.Deadline) {
                    const parts = item.Deadline.split('/');
                    if (parts.length === 3) {
                        const deadDate = new Date(parseInt(parts[0]) + 1911, parseInt(parts[1]) - 1, parseInt(parts[2]));
                        if (deadDate < now) isExpired = true;
                    }
                }
                if (type === 'today') { if (!matchDate) return false; } 
                else if (type === 'history') { if (matchDate || isExpired) return false; } 
                else if (type === 'expired') { if (!isExpired) return false; }
                if (keyword) {
                    const searchStr = (item.Title + item.Tags + item.Org + item.Source + item.Deadline).toLowerCase();
                    if (!searchStr.includes(keyword.toLowerCase())) return false;
                }
                return true;
            });
        }

        // â˜… è§¸ç™¼åˆ†æ (ç¶­æŒåŸæ¨£)
        async function startAnalysis(btnId, title, org) {
            const btn = document.getElementById(btnId);
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> æœå°‹ä¸­...`;

            try {
                if (!historyDataCache) {
                    await new Promise((resolve, reject) => {
                        Papa.parse(historyCsvUrl, {
                            download: true, header: true,
                            complete: function(results) {
                                historyDataCache = results.data;
                                console.log("æ­·å²è³‡æ–™åº«ä¸‹è¼‰å®Œæˆ", historyDataCache.length);
                                resolve();
                            },
                            error: function(err) { reject(err); }
                        });
                    });
                }
                await new Promise(r => setTimeout(r, 600));
                const result = performAnalysis(title, org);
                showResultModal(result, title);
            } catch (error) {
                console.error(error);
                Swal.fire({ icon: 'error', title: 'è®€å–å¤±æ•—', text: 'è«‹æª¢æŸ¥ History CSV é€£çµæ˜¯å¦æ­£ç¢º', background: '#1e293b', color: '#f8fafc' });
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // â˜… åˆ†æé‹ç®—é‚è¼¯ (ç¶­æŒåŸæ¨£)
        function performAnalysis(currentTitle, currentOrg) {
            const coreTitle = currentTitle.replace(/\d{3}å¹´åº¦?|\d{4}å¹´?/g, "").replace(/å…¬å‘Š|æ‹›æ¨™|æ¡ˆ|è¨ˆç•«|å‹å‹™|æ¡è³¼/g, "").trim();
            const matches = historyDataCache.filter(row => {
                const rowOrg = row['Org'] || row['æ©Ÿé—œåç¨±'];
                const rowTitle = row['Title'] || row['æ¨™æ¡ˆåç¨±'];
                return rowOrg === currentOrg && rowTitle && rowTitle.includes(coreTitle);
            });

            if (matches.length === 0) return null;

            matches.sort((a, b) => (b.Date || "").localeCompare(a.Date || ""));
            const lastCase = matches[0];
            let topWinner = "è³‡æ–™åº«ç„¡ç´€éŒ„";
            const winners = matches.map(m => m.Winner || m.å¾—æ¨™å» å•†).filter(w => w);
            if(winners.length > 0) {
                const counts = {};
                winners.forEach(w => counts[w] = (counts[w] || 0) + 1);
                topWinner = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
            }

            return {
                count: matches.length,
                lastDate: lastCase.Date,
                lastTitle: lastCase.Title || lastCase.æ¨™æ¡ˆåç¨±,
                lastAmount: lastCase.Budget || lastCase.é ç®—é‡‘é¡,
                lastWinner: lastCase.Winner || lastCase.å¾—æ¨™å» å•† || "ç„¡è³‡æ–™",
                dominantWinner: topWinner
            };
        }

        // â˜… é¡¯ç¤ºçµæœè¦–çª— (ä¿®æ”¹ç‚ºæ·±è‰²ä¸»é¡Œ)
        function showResultModal(data, currentTitle) {
            if (!data) {
                Swal.fire({
                    icon: 'info', title: 'æŸ¥ç„¡æ­·å²é—œè¯',
                    text: 'é€™ä¼¼ä¹æ˜¯ä¸€å€‹å…¨æ–°çš„æ¡ˆä»¶ï¼Œéå»è³‡æ–™åº«ä¸­æ²’æœ‰ç›¸ä¼¼ç´€éŒ„ã€‚',
                    confirmButtonColor: '#0ea5e9',
                    background: '#1e293b', color: '#f8fafc'
                });
                return;
            }
            Swal.fire({
                title: 'ğŸ“Š æˆ°æƒ…åˆ†æå ±å‘Š',
                html: `
                    <div style="text-align: left; font-size: 0.95rem; color: #f8fafc;">
                        <p class="mb-2"><strong>ğŸ¯ ç›®å‰æ¨™æ¡ˆï¼š</strong><br>${currentTitle}</p>
                        <hr style="border-color: rgba(14, 165, 233, 0.3);">
                        <p class="mb-1"><strong>ğŸ” æ­·å²é—œè¯ï¼š</strong> ç™¼ç¾ <span style="color:#ff3366; font-weight:bold;">${data.count}</span> ç­†ç›¸ä¼¼æ¡ˆä»¶</p>
                        <p class="mb-1"><strong>ğŸ“… æœ€è¿‘ä¸€æ¬¡ï¼š</strong> ${data.lastDate}</p>
                        <p class="mb-1"><strong>ğŸ“ æ­·å²æ¡ˆåï¼š</strong> ${data.lastTitle}</p>
                        <p class="mb-1"><strong>ğŸ’° æ­·å²é‡‘é¡ï¼š</strong> <span style="color:#f59e0b; font-weight:bold;">${data.lastAmount}</span></p>
                        <div class="mt-3 p-2 rounded border" style="background: rgba(14, 165, 233, 0.1); border-color: #0ea5e9;">
                            <p class="mb-0"><strong>ğŸ† æ­·å¹´éœ¸ä¸»ï¼š</strong> <span style="color:#0ea5e9; font-weight:bold;">${data.dominantWinner}</span></p>
                            <small style="color:#94a3b8;">(å‡ºç¾é »ç‡æœ€é«˜çš„å» å•†)</small>
                        </div>
                    </div>
                `,
                icon: 'success',
                confirmButtonText: 'äº†è§£æƒ…è³‡', confirmButtonColor: '#0ea5e9',
                background: '#1e293b', color: '#f8fafc'
            });
        }

        // æ¸²æŸ“åˆ—è¡¨ (HTML ç”¢ç”Ÿå™¨ - ä¿®æ”¹ç‚ºæ–°æ¨£å¼)
        function renderList(data, containerId, groupByDate) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-folder-open fa-3x mb-3"></i><br>ç›®å‰æ²’æœ‰è³‡æ–™</div>';
                return;
            }

            let html = '';
            let lastDate = '';

            data.forEach((item, index) => {
                if (groupByDate && item.Date !== lastDate) {
                    html += `<div class="date-separator"><span class="date-text"><i class="far fa-calendar-alt me-2"></i>${item.Date}</span></div>`;
                    lastDate = item.Date;
                }

                const isPis = item.Source && item.Source.includes("æ¡è³¼");
                const borderClass = isPis ? 'source-pis' : 'source-env';
                const btnId = `analyze-${containerId}-${index}`;
                const orgName = item.Org || item.Source; 

                html += `
                    <div class="tender-card-tech ${borderClass}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="mb-2">
                                    <span class="org-badge-tech me-2"><i class="fas fa-building me-1"></i>${orgName}</span>
                                    <span class="tag-badge-tech"><i class="fas fa-tag me-1"></i>${item.Tags || 'ä¸€èˆ¬'}</span>
                                    <button id="${btnId}" class="btn-analyze-tech ms-3" onclick="startAnalysis('${btnId}', '${item.Title}', '${item.Org}')">
                                        <i class="fas fa-chart-line me-1"></i>æˆ°æƒ…åˆ†æ
                                    </button>
                                </div>
                                <a href="${item.Link}" target="_blank" class="tender-title-tech">${item.Title}</a>
                                <div class="info-row-tech">
                                    ${item.Budget ? `<div class="info-item-tech"><i class="fas fa-coins"></i><span class="budget-text">$${item.Budget}</span></div>` : ''}
                                    ${item.Deadline ? `<div class="info-item-tech"><i class="fas fa-hourglass-half"></i><span class="deadline-text">æˆªæ­¢: ${item.Deadline}</span></div>` : ''}
                                    ${!groupByDate ? `<div class="info-item-tech"><i class="far fa-clock"></i>${item.Date}</div>` : ''}
                                </div>
                            </div>
                            <div class="ms-3 d-none d-sm-block align-self-center">
                                <a href="${item.Link}" target="_blank" class="btn-view-tech">æŸ¥çœ‹å…¬å‘Š</a>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // æ›´æ–°çµ±è¨ˆæ•¸æ“š (ç¶­æŒåŸæ¨£)
        function updateStats() {
            document.getElementById('totalCount').innerText = allData.length;
            const todayCount = allData.filter(item => item.Date && item.Date.includes(todayStr)).length;
            document.getElementById('todayCount').innerText = todayCount;
            document.getElementById('historyCount').innerText = allData.length - todayCount;
        }
    </script>
</body>
</html>


