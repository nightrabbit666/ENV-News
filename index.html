<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¿åºœæ‹›æ¨™ç›£æ§å„€è¡¨æ¿</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; padding-bottom: 50px;}
        
        /* æ¨™é¡Œå€å¡Š */
        .header { 
            background: linear-gradient(135deg, #0062E6, #33AEFF); 
            color: white; 
            padding: 2.5rem 0; 
            margin-bottom: 2rem; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            position: relative;
        }

        /* ç³»çµ±ç‹€æ…‹æ¢ (ç½®é ‚) */
        #status-bar { display: none; padding: 8px 20px; font-size: 0.9rem; text-align: center; color: white; font-weight: bold;}
        .status-error { background-color: #dc3545; } 
        .status-ok { position: absolute; top: 10px; right: 10px; font-size: 0.8rem; opacity: 0.8; }

        /* å¡ç‰‡è¨­è¨ˆ */
        .card-custom { 
            border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); 
            background: white; margin-bottom: 15px; transition: transform 0.2s; 
            border-left: 5px solid transparent; padding: 20px;
        }
        .card-custom:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        .source-pis { border-left-color: #ffc107; } /* é»ƒ */
        .source-env { border-left-color: #28a745; } /* ç¶  */
        
        .badge-tag { font-size: 0.85rem; padding: 5px 10px; border-radius: 6px; font-weight: normal;}
        .bg-pis { background-color: #fff3cd; color: #856404; }
        .bg-env { background-color: #d4edda; color: #155724; }
        
        .news-link { text-decoration: none; color: #2c3e50; font-weight: 700; font-size: 1.15rem; display: block; margin-bottom: 8px; line-height: 1.4;}
        .news-link:hover { color: #0062E6; text-decoration: underline;}
        
        .search-bar { border-radius: 50px; padding: 12px 25px; border: 1px solid #ced4da; width: 100%; max-width: 600px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .nav-pills .nav-link { border-radius: 50px; padding: 10px 25px; font-weight: 600; color: #6c757d; margin: 0 5px;}
        .nav-pills .nav-link.active { background-color: #0062E6; color: white; box-shadow: 0 4px 10px rgba(0, 98, 230, 0.3); }
        
        .date-separator { display: flex; align-items: center; margin: 30px 0 20px 0; color: #adb5bd; font-size: 0.9rem; font-weight: bold; }
        .date-separator::before, .date-separator::after { content: ""; flex: 1; border-bottom: 1px solid #dee2e6; }
        .date-text { background-color: #e9ecef; color: #495057; padding: 5px 15px; border-radius: 20px; }

        .info-row { font-size: 0.9rem; color: #666; display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px;}
        .info-item { display: flex; align-items: center; background: #f8f9fa; padding: 4px 10px; border-radius: 20px;}
        .info-item i { margin-right: 6px; color: #adb5bd; }
        .budget-text { color: #dc3545; font-weight: bold; }
        .deadline-text { color: #d63384; font-weight: bold; }

        .loading { text-align: center; padding: 50px; color: #6c757d; }
        .empty-state { text-align: center; padding: 60px; color: #adb5bd; }
        .keyword-btn { font-size: 0.85rem; margin: 3px; border: 1px solid #dee2e6; background: white; color: #6c757d;}
        .keyword-btn:hover { background: #e9ecef; color: #495057; }
        .keyword-btn.active { background: #6c757d; color: white; border-color: #6c757d; }

        /* â˜… æ–°å¢ï¼šåˆ†ææŒ‰éˆ•æ¨£å¼ */
        .btn-analyze {
            background-color: #17a2b8; color: white; font-size: 0.8rem; padding: 2px 10px;
            border-radius: 20px; border: none; cursor: pointer; transition: all 0.3s;
            display: inline-flex; align-items: center;
        }
        .btn-analyze:hover { background-color: #138496; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-analyze:disabled { background-color: #6c757d; cursor: not-allowed; opacity: 0.7; }
        .spinner-border-sm { width: 0.8rem; height: 0.8rem; border-width: 0.15em; margin-right: 5px; }
    </style>
</head>
<body>

    <div id="status-bar"></div>

    <div class="header text-center">
        <div id="last-update" class="status-ok" style="display:none"></div>
        <h1 class="fw-bold pt-2"><i class="fas fa-search-dollar me-2"></i>æ¨™æ¡ˆèˆ‡æ–°èæˆ°æƒ…å®¤</h1>
        <p class="opacity-75 mb-0">å³æ™‚ç›£æ§ï¼šè³‡æºå¾ªç’°ç½² / ç’°å¢ƒç®¡ç†ç½² / æ”¿åºœæ¡è³¼ç¶²</p>
    </div>

    <div class="container" style="max-width: 900px;">
        <div class="mb-4 text-center">
            <h6 class="text-muted small mb-2">ğŸ“Š é—œéµå­—å¿«ç¯© (é»æ“Šéæ¿¾)</h6>
            <div id="keyword-badges" class="d-flex flex-wrap justify-content-center"></div>
        </div>

        <div class="d-flex justify-content-center mb-4">
            <input type="text" id="searchInput" class="search-bar" placeholder="ğŸ” è¼¸å…¥é—œéµå­—æœå°‹æ¨™é¡Œã€æ©Ÿé—œã€æˆªæ­¢æ—¥...">
        </div>

        <div class="row mb-4 text-center g-3">
            <div class="col-4"><div class="p-3 bg-white rounded shadow-sm border-bottom border-danger border-3"><h2 id="todayCount" class="text-danger fw-bold mb-0">0</h2><small class="text-muted">ä»Šæ—¥æ–°å¢</small></div></div>
            <div class="col-4"><div class="p-3 bg-white rounded shadow-sm border-bottom border-primary border-3"><h2 id="historyCount" class="text-primary fw-bold mb-0">0</h2><small class="text-muted">æ­·å²å­˜é‡</small></div></div>
            <div class="col-4"><div class="p-3 bg-white rounded shadow-sm border-bottom border-dark border-3"><h2 id="totalCount" class="text-dark fw-bold mb-0">0</h2><small class="text-muted">ç¸½è³‡æ–™æ•¸</small></div></div>
        </div>

        <ul class="nav nav-pills mb-4 justify-content-center" id="pills-tab" role="tablist">
            <li class="nav-item"><button class="nav-link active" id="pills-today-tab" data-bs-toggle="pill" data-bs-target="#pills-today">ğŸ”¥ ä»Šæ—¥å¿«è¨Š</button></li>
            <li class="nav-item"><button class="nav-link" id="pills-history-tab" data-bs-toggle="pill" data-bs-target="#pills-history">ğŸ—„ï¸ æ­·å²æŸ¥è©¢å…§å®¹</button></li>
            <li class="nav-item"><button class="nav-link" id="pills-expired-tab" data-bs-toggle="pill" data-bs-target="#pills-expired">ğŸ’€ å·²æˆªæ¨™æ¡ˆä»¶</button></li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane fade show active" id="pills-today"><div id="container-today"><div class="loading"><i class="fas fa-spinner fa-spin fa-2x mb-2"></i><br>æ­£åœ¨è®€å–è³‡æ–™åº«...</div></div></div>
            <div class="tab-pane fade" id="pills-history"><div id="container-history"><div class="loading"><i class="fas fa-spinner fa-spin fa-2x mb-2"></i><br>æ­£åœ¨è®€å–è³‡æ–™åº«...</div></div></div>
            <div class="tab-pane fade" id="pills-expired"><div id="container-expired"><div class="loading"><i class="fas fa-spinner fa-spin fa-2x mb-2"></i><br>æ­£åœ¨è®€å–...</div></div></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ==========================================
        // âš ï¸ è¨­å®šå€ï¼šè«‹å¡«å…¥æ‚¨çš„ Google Sheets CSV é€£çµ
        // ==========================================
        
        const sheetCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSL9csppWjrqt8UOwwOwDxI4WON1aujg78zBush52aLIUeFubdpp9Au93c6cgf_qDLuRRX2NP0OvTkJ/pub?gid=0&single=true&output=csv';
        const logCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSL9csppWjrqt8UOwwOwDxI4WON1aujg78zBush52aLIUeFubdpp9Au93c6cgf_qDLuRRX2NP0OvTkJ/pub?gid=469067754&single=true&output=csv'; 
        
        // â˜… è«‹åœ¨æ­¤å¡«å…¥ History åˆ†é çš„ CSV é€£çµ (gid æœƒä¸ä¸€æ¨£)
        const historyCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSL9csppWjrqt8UOwwOwDxI4WON1aujg78zBush52aLIUeFubdpp9Au93c6cgf_qDLuRRX2NP0OvTkJ/pub?gid=175963084&single=true&output=csv'; 

        // ==========================================

        let allData = [];
        let historyDataCache = null; // å¿«å–æ­·å²è³‡æ–™
        let todayStr = "";

        document.addEventListener('DOMContentLoaded', function() {
            const dateObj = new Date();
            todayStr = `${dateObj.getFullYear() - 1911}/${String(dateObj.getMonth() + 1).padStart(2, '0')}/${String(dateObj.getDate()).padStart(2, '0')}`;
            
            fetchData();
            checkSystemStatus();
            
            document.getElementById('searchInput').addEventListener('input', function(e) {
                const keyword = e.target.value;
                document.querySelectorAll('.keyword-btn').forEach(btn => btn.classList.remove('active'));
                
                renderList(filterData(allData, true, keyword), 'container-today', false);
                renderList(filterData(allData, false, keyword), 'container-history', true);
                renderList(filterData(allData, 'expired', keyword), 'container-expired', true);
            });
        });

        // è®€å–ä¸»è³‡æ–™
        function fetchData() {
            Papa.parse(sheetCsvUrl, {
                download: true, header: true,
                complete: function(results) {
                    allData = results.data.filter(item => item.Title && item.Link).reverse();
                    updateStats();
                    renderKeywords();
                    renderList(filterData(allData, true, ''), 'container-today', false);
                    renderList(filterData(allData, false, ''), 'container-history', true);
                    renderList(filterData(allData, 'expired', ''), 'container-expired', true);
                }
            });
        }

        // è®€å–æ—¥èªŒ
        function checkSystemStatus() {
            Papa.parse(logCsvUrl, {
                download: true, header: true,
                complete: function(results) {
                    const logs = results.data.filter(r => r.Time);
                    if (logs.length > 0) {
                        const lastLog = logs[logs.length - 1];
                        const statusBar = document.getElementById('status-bar');
                        const lastUpdate = document.getElementById('last-update');
                        if (lastLog.Status === 'ERROR') {
                            statusBar.className = 'status-error';
                            statusBar.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i> ç³»çµ±ç•°å¸¸è­¦å‘Šï¼š${lastLog.Message}`;
                            statusBar.style.display = 'block';
                        } else {
                            lastUpdate.innerHTML = `<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>ç³»çµ±æ­£å¸¸</span> <span class="small ms-1">æ›´æ–°: ${lastLog.Time}</span>`;
                            lastUpdate.style.display = 'block';
                        }
                    }
                }
            });
        }

        // â˜… æ–°å¢ï¼šè§¸ç™¼åˆ†æ (Lazy Loading)
        async function startAnalysis(btnId, title, org) {
            const btn = document.getElementById(btnId);
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> æœå°‹ä¸­...`;

            try {
                // 1. å¦‚æœé‚„æ²’ä¸‹è¼‰éæ­·å²è³‡æ–™ï¼Œç¾åœ¨ä¸‹è¼‰
                if (!historyDataCache) {
                    await new Promise((resolve, reject) => {
                        Papa.parse(historyCsvUrl, {
                            download: true, header: true,
                            complete: function(results) {
                                historyDataCache = results.data;
                                console.log("æ­·å²è³‡æ–™åº«ä¸‹è¼‰å®Œæˆ", historyDataCache.length);
                                resolve();
                            },
                            error: function(err) { reject(err); }
                        });
                    });
                }

                // 2. æ¨¡æ“¬ç¨å¾®åœé “ (æå‡é«”é©—)
                await new Promise(r => setTimeout(r, 600));

                // 3. åŸ·è¡Œæ¯”å°åˆ†æ
                const result = performAnalysis(title, org);
                
                // 4. é¡¯ç¤ºçµæœ
                showResultModal(result, title);

            } catch (error) {
                console.error(error);
                Swal.fire({ icon: 'error', title: 'è®€å–å¤±æ•—', text: 'è«‹æª¢æŸ¥ History CSV é€£çµæ˜¯å¦æ­£ç¢º' });
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // â˜… æ–°å¢ï¼šåˆ†æé‹ç®—é‚è¼¯
        function performAnalysis(currentTitle, currentOrg) {
            // æ¸…æ´—æ¨™é¡Œï¼šç§»é™¤å¹´ä»½ (å¦‚ 114, 113) èˆ‡é›œå­—
            const coreTitle = currentTitle.replace(/\d{3}å¹´åº¦?|\d{4}å¹´?/g, "").replace(/å…¬å‘Š|æ‹›æ¨™|æ¡ˆ|è¨ˆç•«|å‹å‹™|æ¡è³¼/g, "").trim();
            
            // ç¯©é¸ï¼šæ©Ÿé—œç›¸åŒ ä¸” æ¨™é¡ŒåŒ…å«æ ¸å¿ƒé—œéµå­—
            const matches = historyDataCache.filter(row => {
                const rowOrg = row['Org'] || row['æ©Ÿé—œåç¨±']; // ç›¸å®¹ä¸åŒæ¬„ä½å
                const rowTitle = row['Title'] || row['æ¨™æ¡ˆåç¨±'];
                return rowOrg === currentOrg && rowTitle && rowTitle.includes(coreTitle);
            });

            if (matches.length === 0) return null;

            // æ’åºï¼šæ—¥æœŸæ–°çš„åœ¨å‰
            matches.sort((a, b) => (b.Date || "").localeCompare(a.Date || ""));
            const lastCase = matches[0];
            
            // å˜—è©¦çµ±è¨ˆå¾—æ¨™è€… (è‹¥æœ‰ Winner æ¬„ä½)
            let topWinner = "è³‡æ–™åº«ç„¡ç´€éŒ„";
            const winners = matches.map(m => m.Winner || m.å¾—æ¨™å» å•†).filter(w => w);
            if(winners.length > 0) {
                const counts = {};
                winners.forEach(w => counts[w] = (counts[w] || 0) + 1);
                topWinner = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
            }

            return {
                count: matches.length,
                lastDate: lastCase.Date,
                lastTitle: lastCase.Title || lastCase.æ¨™æ¡ˆåç¨±,
                lastAmount: lastCase.Budget || lastCase.é ç®—é‡‘é¡,
                lastWinner: lastCase.Winner || lastCase.å¾—æ¨™å» å•† || "ç„¡è³‡æ–™",
                dominantWinner: topWinner
            };
        }

        // â˜… æ–°å¢ï¼šé¡¯ç¤ºçµæœè¦–çª—
        function showResultModal(data, currentTitle) {
            if (!data) {
                Swal.fire({
                    icon: 'info', title: 'æŸ¥ç„¡æ­·å²é—œè¯',
                    text: 'é€™ä¼¼ä¹æ˜¯ä¸€å€‹å…¨æ–°çš„æ¡ˆä»¶ï¼Œéå»è³‡æ–™åº«ä¸­æ²’æœ‰ç›¸ä¼¼ç´€éŒ„ã€‚',
                    confirmButtonColor: '#3085d6',
                });
                return;
            }
            Swal.fire({
                title: 'ğŸ“Š æˆ°æƒ…åˆ†æå ±å‘Š',
                html: `
                    <div style="text-align: left; font-size: 0.95rem;">
                        <p class="mb-2"><strong>ğŸ¯ ç›®å‰æ¨™æ¡ˆï¼š</strong><br>${currentTitle}</p>
                        <hr>
                        <p class="mb-1"><strong>ğŸ” æ­·å²é—œè¯ï¼š</strong> ç™¼ç¾ <span class="text-danger fw-bold">${data.count}</span> ç­†ç›¸ä¼¼æ¡ˆä»¶</p>
                        <p class="mb-1"><strong>ğŸ“… æœ€è¿‘ä¸€æ¬¡ï¼š</strong> ${data.lastDate}</p>
                        <p class="mb-1"><strong>ğŸ“ æ­·å²æ¡ˆåï¼š</strong> ${data.lastTitle}</p>
                        <p class="mb-1"><strong>ğŸ’° æ­·å²é‡‘é¡ï¼š</strong> ${data.lastAmount}</p>
                        <div class="mt-3 p-2 bg-light rounded border">
                            <p class="mb-0"><strong>ğŸ† æ­·å¹´éœ¸ä¸»ï¼š</strong> <span class="text-primary fw-bold">${data.dominantWinner}</span></p>
                            <small class="text-muted">(å‡ºç¾é »ç‡æœ€é«˜çš„å» å•†)</small>
                        </div>
                    </div>
                `,
                icon: 'success',
                confirmButtonText: 'äº†è§£', confirmButtonColor: '#17a2b8'
            });
        }

        // æ¸²æŸ“åˆ—è¡¨ (HTML ç”¢ç”Ÿå™¨)
        function renderList(data, containerId, groupByDate) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-folder-open fa-3x mb-3 opacity-25"></i><br>ç›®å‰æ²’æœ‰è³‡æ–™</div>';
                return;
            }

            let html = '';
            let lastDate = '';

            data.forEach((item, index) => {
                if (groupByDate && item.Date !== lastDate) {
                    html += `<div class="date-separator"><span class="date-text"><i class="far fa-calendar-alt me-2"></i>${item.Date}</span></div>`;
                    lastDate = item.Date;
                }

                const isPis = item.Source && item.Source.includes("æ¡è³¼");
                const borderClass = isPis ? 'source-pis' : 'source-env';
                const badgeClass = isPis ? 'bg-pis' : 'bg-env';
                const btnId = `analyze-${containerId}-${index}`; // å”¯ä¸€ID

                html += `
                    <div class="card-custom ${borderClass}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="mb-2">
                                    <span class="badge ${badgeClass} badge-tag text-dark">${item.Org || item.Source}</span>
                                    <span class="badge bg-light text-secondary border badge-tag ms-1"><i class="fas fa-tag me-1"></i>${item.Tags || 'ä¸€èˆ¬'}</span>
                                    <button id="${btnId}" class="btn-analyze ms-2" onclick="startAnalysis('${btnId}', '${item.Title}', '${item.Org}')">
                                        <i class="fas fa-chart-line me-1"></i>æˆ°æƒ…åˆ†æ
                                    </button>
                                </div>
                                <a href="${item.Link}" target="_blank" class="news-link">${item.Title}</a>
                                <div class="info-row">
                                    ${item.Budget ? `<div class="info-item"><i class="fas fa-coins"></i><span class="budget-text">$${item.Budget}</span></div>` : ''}
                                    ${item.Deadline ? `<div class="info-item"><i class="fas fa-hourglass-half"></i><span class="deadline-text">æˆªæ­¢: ${item.Deadline}</span></div>` : ''}
                                    ${!groupByDate ? `<div class="info-item"><i class="far fa-clock"></i>${item.Date}</div>` : ''}
                                </div>
                            </div>
                            <div class="ms-3 d-none d-sm-block align-self-center">
                                <a href="${item.Link}" target="_blank" class="btn btn-outline-secondary btn-sm rounded-pill px-4">æŸ¥çœ‹</a>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // å…¶ä»–åŸºç¤åŠŸèƒ½ (Filter, Stats, Keywords) ç¶­æŒèˆ‡åŸç‰ˆé‚è¼¯ä¸€è‡´ï¼Œå·²æ•´åˆåœ¨ä¸Šæ–¹ fetchData ä¸­
        function updateStats() {
            document.getElementById('totalCount').innerText = allData.length;
            const todayCount = allData.filter(item => item.Date && item.Date.includes(todayStr)).length;
            document.getElementById('todayCount').innerText = todayCount;
            document.getElementById('historyCount').innerText = allData.length - todayCount;
        }
        function renderKeywords() {
            const keywordMap = {};
            allData.forEach(item => {
                if (item.Tags) {
                    let parts = item.Tags.split('-');
                    let kw = parts.length > 1 ? parts[1] : item.Tags;
                    keywordMap[kw] = (keywordMap[kw] || 0) + 1;
                }
            });
            const container = document.getElementById('keyword-badges');
            let html = '';
            Object.entries(keywordMap).sort((a, b) => b[1] - a[1]).forEach(([key, count]) => {
                html += `<button class="btn btn-sm rounded-pill keyword-btn" onclick="setSearch('${key}', this)">${key} <span class="badge bg-secondary text-white ms-1" style="font-size:0.7rem">${count}</span></button>`;
            });
            container.innerHTML = html;
        }
        function setSearch(keyword, btnElement) {
            const searchInput = document.getElementById('searchInput');
            searchInput.value = keyword;
            searchInput.dispatchEvent(new Event('input'));
            document.querySelectorAll('.keyword-btn').forEach(btn => btn.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');
        }
        function filterData(data, type, keyword) {
            const now = new Date(); now.setHours(0,0,0,0);
            return data.filter(item => {
                const itemDate = item.Date || "";
                const matchDate = itemDate.includes(todayStr);
                let isExpired = false;
                if (item.Deadline) {
                    const parts = item.Deadline.split('/');
                    if (parts.length === 3) {
                        const deadDate = new Date(parseInt(parts[0]) + 1911, parseInt(parts[1]) - 1, parseInt(parts[2]));
                        if (deadDate < now) isExpired = true;
                    }
                }
                if (type === 'today') { if (!matchDate) return false; } 
                else if (type === 'history') { if (matchDate || isExpired) return false; } 
                else if (type === 'expired') { if (!isExpired) return false; }
                if (keyword) {
                    const searchStr = (item.Title + item.Tags + item.Org + item.Source + item.Deadline).toLowerCase();
                    if (!searchStr.includes(keyword.toLowerCase())) return false;
                }
                return true;
            });
        }
    </script>
</body>
</html>
